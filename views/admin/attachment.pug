extends layout

block content
  .container(class='mx-auto px-4 py-8')
    .header(class='flex justify-between items-center mb-6')
      h2(class='text-2xl font-bold') é™„ä»¶ç®¡ç†
      button#uploadBtn(class='bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded')
        | ä¸Šä¼ æ–‡ä»¶
      input#fileInput(type='file' class='hidden')
    
    #loading(class='text-center py-8 hidden')
      p(class='text-gray-500') æ­£åœ¨åŠ è½½é™„ä»¶åˆ—è¡¨...
    
    #error(class='text-center py-8 text-red-500 hidden')
      p åŠ è½½é™„ä»¶åˆ—è¡¨å¤±è´¥
    
    .attachments-grid(class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4')

  script.
    document.addEventListener('DOMContentLoaded', function() {
      const uploadBtn = document.getElementById('uploadBtn');
      const fileInput = document.getElementById('fileInput');
      const attachmentsGrid = document.querySelector('.attachments-grid');
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');

      // åŠ è½½é™„ä»¶åˆ—è¡¨
      async function loadAttachments() {
        loadingEl.classList.remove('hidden');
        errorEl.classList.add('hidden');
        attachmentsGrid.innerHTML = '';

        try {
          const response = await fetch('/api/admin/attachments');
          const result = await response.json();

          if (response.ok) {
            if (result.data && result.data.length > 0) {
              result.data.forEach(attachment => {
                const card = document.createElement('div');
                card.className = 'attachment-card bg-white rounded-lg shadow-md p-4';
                
                const preview = document.createElement('div');
                preview.className = 'preview mb-4 h-40 flex items-center justify-center bg-gray-100 rounded';
                
                if (attachment.mime_type.startsWith('image/')) {
                  const img = document.createElement('img');
                  img.src = attachment.path;
                  img.className = 'max-h-full max-w-full object-contain';
                  preview.appendChild(img);
                } else {
                  const fileIcon = document.createElement('div');
                  fileIcon.className = 'file-icon text-4xl text-gray-400';
                  fileIcon.textContent = 'ğŸ“„';
                  preview.appendChild(fileIcon);
                }
                
                const info = document.createElement('div');
                info.className = 'info space-y-2';
                info.innerHTML = `
                  <div class="filename font-medium truncate">${attachment.filename}</div>
                  <div class="details text-sm text-gray-500">
                    <div class="size">${Math.round(attachment.size / 1024)} KB</div>
                    <div class="type">${attachment.mime_type}</div>
                    <div class="date">${new Date(attachment.created_at).toLocaleDateString()}</div>
                  </div>
                  <div class="actions flex justify-end mt-2">
                    <button class="delete-btn text-red-500 hover:text-red-600" data-id="${attachment.aid}">åˆ é™¤</button>
                  </div>
                `;
                
                card.appendChild(preview);
                card.appendChild(info);
                attachmentsGrid.appendChild(card);
              });

              // é‡æ–°ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
              bindDeleteButtons();
            } else {
              attachmentsGrid.innerHTML = `
                <div class="no-attachments col-span-3 text-center py-8 text-gray-500">
                  <p>æš‚æ— é™„ä»¶</p>
                </div>
              `;
            }
          } else {
            throw new Error(result.error || 'åŠ è½½å¤±è´¥');
          }
        } catch (error) {
          errorEl.classList.remove('hidden');
        } finally {
          loadingEl.classList.add('hidden');
        }
      }

      // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
      function bindDeleteButtons() {
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const confirmed = await showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé™„ä»¶å—ï¼Ÿ');
            
            if (confirmed) {
              try {
                const response = await fetch(`/api/admin/attachments/${id}`, {
                  method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                  showToast('åˆ é™¤æˆåŠŸ', 'success');
                  loadAttachments(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                  showToast(result.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
              } catch (error) {
                showToast('åˆ é™¤å¤±è´¥', 'error');
              }
            }
          });
        });
      }

      // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
      uploadBtn.addEventListener('click', () => {
        fileInput.click();
      });

      // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch('/api/admin/attachments', {
            method: 'POST',
            body: formData
          });

          const result = await response.json();
          if (response.ok) {
            showToast('ä¸Šä¼ æˆåŠŸ', 'success');
            loadAttachments(); // é‡æ–°åŠ è½½åˆ—è¡¨
          } else {
            showToast(result.error || 'ä¸Šä¼ å¤±è´¥', 'error');
          }
        } catch (error) {
          showToast('ä¸Šä¼ å¤±è´¥', 'error');
        }
      });

      // åˆå§‹åŠ è½½é™„ä»¶åˆ—è¡¨
      loadAttachments();
    });